<canvas id="ctx" width="500" height="500" style="border: 1px solid #000"></canvas>
<script type="text/javascript" src="./js/Entities.js"></script>
<script type="text/javascript">
	var ctx  = document.getElementById('ctx').getContext('2d')

	//1. Modify Settings =
	ctx.font = '30px Arial';  //; font used
	// ctx.fillStyle = 'red';		// color of the text and forms
	// ctx.globalAlpha = 0.5;		// transparency 0: invisible ; 1: visible
	
	// 2. Draw something
	// ctx.fillText('Hello',50,50); //write text ... ctx.fillText('text', x, y)
	// ctx.fillRect(50,50,100,100); // draw rectangle .. ctx.fillRect(startX, startY, width, height)
	// ctx.clearRect(75,75,100,100); // clear canvas ... ctx.fillRect(startX, startY, width, height)
	const DISTANCE_COLLIDING= 30;
	const WIDTH= 500;
	const HEIGHT= 500;
	let timeWhenGameStartedssddd = Date.now();
	let frameCount = 0;
	let score = 0;
	let currentMap;

	//step 1: loading the image (in the memory) ONCE
	let Img = {};
	Img.player = new Image();
	Img.player.src = "img/player.png";
	Img.enemy = new Image();
	Img.enemy.src = 'img/enemy.png';
	Img.bullet = new Image();
	Img.bullet.src = 'img/bullet.png';
	Img.upgrade1 = new Image();
	Img.upgrade1.src = 'img/upgrade1.png';
	Img.upgrade2 = new Image();
	Img.upgrade2.src = 'img/upgrade2.png';
	Img.map = new Image();
	Img.map.src = 'img/map.png';


	document.onmousemove = function (mouse){
		var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
		var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

		// mouseX -= player.x;
		// mouseY -= player.y;

		mouseX -= WIDTH/2;
		mouseY -= HEIGHT/2;

		player.aimAngle = Math.atan2(mouseY,mouseX) / Math.PI * 180;
	}

	document.onclick = function(mouse){ // left click
		player.performAttack();
	};

	document.oncontextmenu = function(mouse){ // right click
		player.performSpecialAttack();
		mouse.preventDefault();
	};

	// Keyboard movement
	document.onkeydown = function(event){
        if(event.keyCode === 68)        //d
                player.pressingRight = true;
        else if(event.keyCode === 83)   //s
                player.pressingDown = true;
        else if(event.keyCode === 65) //a
                player.pressingLeft = true;
        else if(event.keyCode === 87) // w
                player.pressingUp = true;
	}
	 
	document.onkeyup = function(event){
        if(event.keyCode === 68)        //d
                player.pressingRight = false;
        else if(event.keyCode === 83)   //s
                player.pressingDown = false;
        else if(event.keyCode === 65) //a
                player.pressingLeft = false;
        else if(event.keyCode === 87) // w
                player.pressingUp = false;
	}

	// main application
	update = function (){
		ctx.clearRect(0,0,WIDTH,HEIGHT); // xoa het noi dung trong canvas truoc khi ve lai
		currentMap.draw();
		frameCount++;
		score++;
		if(frameCount % 100 === 0)
			randomlyGenerateEnemy();

		if(frameCount % 75 === 0)
			randomlyGenerateUpgrade();

 		for(var key in bulletList){
 			bulletList[key].update();  
        }

		for(var upgradeIndex in upgradeList){ 
			upgradeList[upgradeIndex].update();
		}

		for(var enemyIndex in enemyList){
			enemyList[enemyIndex].update();
		}

		player.update();
		// player.attackCounter += player.atkSpd;

		ctx.fillText(`${player.hp} hp `,0,30);
		ctx.fillText(`Score: ${score} `,300,30);
	}

	startNewGame = function () {
		player.hp = 20;
		timeWhenGameStarted = Date.now();
		frameCount = 0;
		score = 0;
		enemyList = {};
		upgradeList = {};
		bulletList = {};
		randomlyGenerateEnemy();
		randomlyGenerateEnemy();
		randomlyGenerateEnemy();
	}

	//------------------------RUN APPLICATION---------------------------

	//draw map
 	Maps = function(id, imgSrc, width, height){
 		var self = {
 			id : id,
 			image: new Image(),
 			width: width,
 			height: height
 		};

 		self.image.src = imgSrc;

 		self.draw = function() {
 			let x = WIDTH/2 - player.x; 
			let y = HEIGHT/2 - player.y;

			ctx.drawImage(Img.map, 
				0,0,Img.map.width, Img.map.height, //cropStartX, cropStartY, cropWidth, cropHeight
				x,y,Img.map.width*2,Img.map.height*2//drawX, drawY, drawWidth, drawHeight
			);
 		}

 		return self;
 	};

 	currentMap = Maps('Map 1','img/map.png',1280,960);

	player = Player();// create player
	startNewGame();// start game

	setInterval(update, 40);
	

</script>